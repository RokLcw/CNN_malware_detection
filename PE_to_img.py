import os
import pandas as pd
import tensorflow as tf
import matplotlib.pyplot as plt
import numpy as np
from keras.preprocessing.image import ImageDataGenerator
from PIL import Image
import pefile
import sys

# text + data 이미지화

data = pd.DataFrame()   # columns=['binary']

folder_path = "./capstone_sample2"
folder_lists = os.listdir(folder_path)

for folder in folder_lists: 
    cnt = 0
    file_path = os.path.join(folder_path, folder)
    file_lists = os.listdir(file_path)

    for file in file_lists:
        check = 0
        # pe = pefile.PE(file_path+"\\"+file, fast_load=True)
        pe = pefile.PE(file_path+"\\"+file, fast_load=True)
        print(file_path+"\\"+file)
        for section in pe.sections:
            if '.text' in str(section.Name):
                entry = section.PointerToRawData - 1
                end = section.SizeOfRawData + entry
                raw_data = pe.__data__[entry:end]
                data = raw_data
            if '.data' in str(section.Name):
                entry = section.PointerToRawData - 1
                end = section.SizeOfRawData + entry
                raw_data = pe.__data__[entry:end]
                data2 = raw_data
        np.hstack([data, data2])



        if(len(data) < 64*64):
            image = Image.new('L', (64, 64))
        elif(len(data) < 128*128):
            image = Image.new('L', (128, 128))
        elif(len(data) < 256*256):
            image = Image.new('L', (256, 256))
        elif(len(data) < 512*512):
            image = Image.new('L', (512, 512))
        elif(len(data) < 1024*1024):
            image = Image.new('L', (1024, 1024))
        elif(len(data) < 2048*2048):
            image = Image.new('L', (2048, 2048))
        elif(len(data) < 4096*4096):
            image = Image.new('L', (4096, 4096))
        
        image.putdata(data)
        image = image.resize((64, 64))

        if cnt < 8000:
            if 'abnormal' in folder:
                # imagename = f"./CNN/PE_basic(Data)_IMG/Train/{folder}/{file}.png"
                imagename = f"./CNN/Random_Test_IMG/{folder}/{file}.png"
            if 'normal' in folder:
                # imagename = f"./CNN/PE_basic(Data)_IMG/Train/{folder}/{file}.png"
                imagename = f"./CNN/Random_Test_IMG/{folder}/{file}.png"
        else:
            if 'abnormal' in folder:
                # imagename = f"./CNN/PE_basic(Data)_IMG/Test/{folder}/{file}.png"
                imagename = f"./CNN/Random_Test_IMG/{folder}/{file}.png"
            if 'normal' in folder:
                # imagename = f"./CNN/PE_basic(Data)_IMG/Test/{folder}/{file}.png"
                imagename = f"./CNN/Random_Test_IMG/{folder}/{file}.png"
        
        image.save(imagename)

        cnt += 1

    print(folder, " cnt: ", cnt)

print("전처리 완료")