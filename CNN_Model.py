import os
import pandas as pd
import tensorflow as tf
import matplotlib.pyplot as plt
import numpy as np
import time
from PIL import Image

start_time = time.time()

train_folder_path = "./CNN/PE_basic(text_data)_IMG/Train"

# train 데이터 셋 가져오기
train_ds = tf.keras.preprocessing.image_dataset_from_directory(
    train_folder_path,
    image_size=(64,64),
    batch_size=512,
    subset='training',
    validation_split=0.2,
    color_mode = 'grayscale',
    seed=42
)

# validation 데이터 셋 가져오기
val_ds = tf.keras.preprocessing.image_dataset_from_directory(
    train_folder_path,
    image_size=(64,64),
    batch_size=512,
    subset='validation',   
    color_mode = 'grayscale',
    validation_split=0.2,
    seed=42
)
# seed 42? : https://velog.io/@d9249/Deep-Learning-seed-42%EB%9E%80

# 정규화
def Pretreatment(i, result):
    i=tf.cast(i/255.0, tf.float32)
    return i, result

train_ds = train_ds.map(Pretreatment)
val_ds = val_ds.map(Pretreatment)

model = tf.keras.Sequential([
    tf.keras.layers.experimental.preprocessing.RandomFlip('horizontal', input_shape=(64, 64, 1)),   # 이미지 증강
    tf.keras.layers.Conv2D(32, (3,3), padding="same", activation="relu"),  # 컨볼루션 레이어
    tf.keras.layers.MaxPooling2D((2, 2)),
    tf.keras.layers.Conv2D(64, (3,3), padding="same", activation="relu"),  # 컨볼루션 레이어
    tf.keras.layers.MaxPooling2D((2, 2)),
    tf.keras.layers.Dropout(0.2),   # 학습용 데이터 외우는거 방지, 오버비팅 완화
    tf.keras.layers.Conv2D(128, (3,3), padding="same", activation="relu"),  # 컨볼루션 레이어
    tf.keras.layers.MaxPooling2D((2, 2)),
    tf.keras.layers.Flatten(),  # 1차원 데이터로 만들어줌 (이미지를 한줄로 쭉)
    tf.keras.layers.Dense(128, activation="relu"),
    tf.keras.layers.Dropout(0.2),   # 학습용 데이터 외우는거 방지, 오버비팅 완화
    tf.keras.layers.Dense(1, activation="sigmoid"), # 클래스 네임(카테코리) 1개
])

model.summary()

model.compile(loss="binary_crossentropy", optimizer="adam", metrics=['accuracy'])
result_train = model.fit(train_ds, validation_data=val_ds, epochs=17) # validation_data: 오버피팅 방지(학습용 데이터 외움), epochs 마다 테스트

# 그래프로 Validation accuracy 와 Trainning accuracy 비교
# plt.plot(result_train.history['accuracy'], label='Train Accuracy')
# plt.plot(result_train.history['val_accuracy'], label='Validation Accuracy')
# plt.ylabel('accuracy')
# plt.xlabel('epoch')
# plt.legend()
# plt.show()

# test 데이터 셋 가져오기
folder_path = "./CNN/PE_basic(text_data)_IMG/Test"
folder_lists = os.listdir(folder_path)

image_list = []
image_label = []

for folder in folder_lists: 
	file_path = os.path.join(folder_path, folder)
	file_lists = os.listdir(file_path)

	for file in file_lists:
		path = file_path + "\\" + file
		image = Image.open(path)
		image_numpy = np.array(image)
		image_list.append(image_numpy)

		if 'normal' in folder:
			image_label.append(0)
		elif 'abnormal' in folder:
			image_label.append(1)

testX = pd.DataFrame()
testY = pd.DataFrame()

testX = np.array(image_list)
testY = np.array(image_label)

# 테스트 데이터셋으로 정답률 확인
score = model.evaluate(testX, testY)
print("정답률:", score[1], "\tloss:", score[0])

end_time = time.time()
print("\nrun time: ", end_time - start_time)

# 그래프로 train, test accuracy 값 비교
plt.title('model accuracy')
plt.plot(result_train.history['accuracy'], label='train')
plt.plot(result_train.history['val_accuracy'], label='test')
plt.ylabel('model accuracy')
plt.xlabel('epoch')
plt.legend()
plt.show()

# 그래프로 train, test loss 값 비교
plt.title('model loss')
plt.plot(result_train.history['loss'], label='train')
plt.plot(result_train.history['val_loss'], label='test')
plt.ylabel('loss')
plt.xlabel('epoch')
plt.legend()
plt.show()