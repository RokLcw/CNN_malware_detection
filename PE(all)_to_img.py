import os
import pandas as pd
import tensorflow as tf
import matplotlib.pyplot as plt
import numpy as np
from keras.preprocessing.image import ImageDataGenerator
from PIL import Image
import pefile
import sys

# binary 파일 그대로 이미자화 하는 코드

data = pd.DataFrame()   # columns=['binary']

folder_path = "./capstone_sample"
folder_lists = os.listdir(folder_path)

for folder in folder_lists: 
    cnt = 0
    file_path = os.path.join(folder_path, folder)
    file_lists = os.listdir(file_path)


    for file in file_lists:

        with open(file_path+"\\"+file, "rb") as f:
            data = f.read()

        if(len(data) < 64*64):
            image = Image.new('L', (64, 64))
        elif(len(data) < 128*128):
            image = Image.new('L', (128, 128))
        elif(len(data) < 256*256):
            image = Image.new('L', (256, 256))
        elif(len(data) < 512*512):
            image = Image.new('L', (512, 512))
        elif(len(data) < 1024*1024):
            image = Image.new('L', (1024, 1024))
        elif(len(data) < 2048*2048):
            image = Image.new('L', (2048, 2048))
        elif(len(data) < 4096*4096):
            image = Image.new('L', (4096, 4096))
        elif(len(data) < 8192*8192):
            image = Image.new('L', (8192, 8192))
        
        try: 
            image.putdata(data)
        except:
            continue
        image = image.resize((64, 64))

        if cnt < 8000:
            if 'abnormal' in folder:
                imagename = f"./CNN/Binary_basic_IMG/Train/{folder}/{file}.png"
            if 'normal' in folder:
                imagename = f"./CNN/Binary_basic_IMG/Train/{folder}/{file}.png"
        else:
            if 'abnormal' in folder:
                imagename = f"./CNN/Binary_basic_IMG/Test/{folder}/{file}.png"
            if 'normal' in folder:
                imagename = f"./CNN/Binary_basic_IMG/Test/{folder}/{file}.png"
        
        image.save(imagename)

        cnt += 1

    print(folder, " cnt: ", cnt)

print("전처리 완료")